<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>layui</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="../../layui/css/layui.css"/>
    <link rel="stylesheet" href="../../css/common.css">
</head>

<body style="width: 100%;padding: 10px 20px;box-sizing: border-box;min-width: 900px;">
<div id="Purchase">
    <form class="layui-form layui-form-pane">
        <div class="layui-form-item">
            <div class="layui-input-block" style="margin-left: 0">
                <ul class="layui-nav" style="background-color: transparent;">
                    <li class="layui-nav-item">
                        <a href="javascript:void(0);" class="iconfont menu-list" title="上一条" id="menu-prev">
                            <i class="layui-icon">&#xe603;</i>
                        </a>
                    </li>
                    <li class="layui-nav-item">
                        <a href="javascript:void(0);" class="iconfont menu-list" title="下一条" id="menu-next">
                            <i class="layui-icon">&#xe602;</i>
                        </a>
                    </li>
                    <li class="layui-nav-item">
                        <a href="javascript:void(0);" class="iconfont menu-list" title="新增" id="menu-add">
                            <i class="layui-icon">&#xe654;</i>
                        </a>
                    </li>
                    <li class="layui-nav-item">
                        <a href="javascript:void(0);" class="iconfont menu-list" title="修改" id="menu-update" disabled>
                            <i class="layui-icon">&#xe642;</i>
                        </a>
                    </li>
                    <li class="layui-nav-item">
                        <a href="javascript:void(0);" class="iconfont menu-list" title="删除" id="menu-delete">
                            <i class="layui-icon">&#xe640;</i>
                        </a>
                    </li>
                    <li class="layui-nav-item">
                        <a href="javascript:void(0);" class="iconfont menu-list" title="保存" id="menu-save">
                            <i class="layui-icon">&#xe61d;</i>
                        </a>
                    </li>
                    <li class="layui-nav-item">
                        <a href="javascript:void(0);" class="iconfont menu-list" title="审核" id="menu-adopt" disabled="">
                            <i class="layui-icon">&#xe605;</i>
                        </a>
                    </li>
                    <li class="layui-nav-item">
                        <a href="javascript:void(0);" class="iconfont menu-list" title="反审核" id="menu-refuse">
                            <i class="layui-icon">&#x1006;</i>
                        </a>
                    </li>
                    <li class="layui-nav-item">
                        <a href="javascript:void(0);" class="iconfont menu-list" title="刷新" id="menu-refresh">
                            <i class="layui-icon">&#x1002;</i>
                        </a>
                    </li>
                    <li class="layui-nav-item" style="margin-left: 20px;">
                        <a href="javascript:void(0);">查询</a>
                        <dl class="layui-nav-child">
                            <dd><a href="javascript:void(0);">历史交易查询</a></dd>
                            <dd><a href="javascript:void(0);">分摊费用明细</a></dd>
                        </dl>
                    </li>
                    <li class="layui-nav-item">
                        <a href="javascript:void(0);">转单</a>
                        <dl class="layui-nav-child">
                            <dd><a href="javascript:void(0);">采购询价转入</a></dd>
                            <dd><a href="javascript:void(0);">采购订单转入</a></dd>
                            <dd><a href="javascript:void(0);">进口商业发票转入</a></dd>
                        </dl>
                    </li>
                </ul>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">供应商</label>
            <div class="layui-input-inline">
                <input type="text" name="cust" lay-verify="cust" autocomplete="off"
                       class="layui-input" readonly="readonly">
            </div>
            <label class="layui-form-label">单据日期</label>
            <div class="layui-input-inline">
                <input type="text" name="billdate" id="date"
                       placeholder="yyyy-mm-dd" class="layui-input"
                       onclick="layui.laydate({elem: this,choose:getBillNo})" readonly="readonly" name="add_overRead"/>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">供应商地址</label>
            <div class="layui-input-inline">
                <input type="text"  lay-verify="title" autocomplete="off"
                       class="layui-input" readonly="readonly" name="add_overRead" id="custaddress">
            </div>
            <label class="layui-form-label">单据号码</label>
            <div class="layui-input-inline">
                <input type="text" id="billno" name="billno add_overRead" lay-verify="title" autocomplete="off"
                       class="layui-input" readonly="readonly">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">采购入库类型</label>
            <div class="layui-input-inline">
                <input type="text" name="billtype" lay-verify="billtype" autocomplete="off"
                       class="layui-input" readonly="readonly">
            </div>
            <label class="layui-form-label">币别</label>
            <div class="layui-input-inline">
                <input type="text" name="curr" lay-verify="title" autocomplete="off"
                       class="layui-input" value="人民币" readonly="readonly">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">单价是否含税</label>
            <div class="layui-input-inline">
                <select name="shui"  disabled="disabled">
                    <option value="0">未税</option>
                    <option value="1">含税</option>
                </select>
            </div>
            <label class="layui-form-label">汇率</label>
            <div class="layui-input-inline">
                <input type="text" name="exchrate" lay-verify="title" autocomplete="off"
                       class="layui-input" value="0.0000" readonly="readonly">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">仓库</label>
            <div class="layui-input-inline">
                <input type="text" name="ware" lay-verify="ware" autocomplete="off"
                       class="layui-input" readonly="readonly">
            </div>
            <label class="layui-form-label">国外贸易</label>
            <div class="layui-input-inline">
                <select name="" disabled="disabled">
                    <option value="是">是</option>
                    <option value="否" selected="selected">否</option>
                </select>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">凭证编号</label>
            <div class="layui-input-inline">
                <input type="text" name="" lay-verify="title" autocomplete="off"
                       class="layui-input" disabled="disabled">
            </div>
            <div class="layui-input-inline">
                <input type="checkbox" lay-skin="primary" name="check" value="复核后自动生成发票"
                       title="复核后自动生成发票">
            </div>
        </div>
        <div class="layui-tab layui-tab-card">
            <ul class="layui-tab-title">
                <li class="layui-this">内容</li>
                <li>账款</li>
                <li>备注</li>
                <a href="javascript:void(0)" id="addLine"><i class="layui-icon" style="font-size: 20px;float: right;position: relative;right: 10px;top: 8px;">&#xe654;</i></a>
            </ul>
            <div class="layui-tab-content">
                <div class="layui-tab-item layui-show">
                    <div style="overflow-x: scroll;">
                        <table class="layui-table" style="width: 3000px;" id="detailinfo">
                            <thead>
                            <tr>
                                <td>(栏号)</td>
                                <td>物料编号</td>
                                <td>(物料名称)</td>
                                <td>(规格型号)</td>
                                <td>(单位名称)</td>
                                <td>数量</td>
                                <td>折扣前单价</td>
                                <td>折数(%)</td>
                                <td>单价</td>
                                <td>金额</td>
                                <td>税率(%)</td>
                                <td>(税额)</td>
                                <td>(含税金额)</td>
                                <td>批号</td>
                                <td>赠品</td>
                                <td>(发票明细)</td>
                                <td>(未发票数量)</td>
                                <td>分录备注</td>
                                <td>(来源单别)</td>
                                <td>(来源单号)</td>
                                <td>(分摊费用)</td>
                            </tr>
                            </thead>
                            <tbody>
                            </tbody>
                            <tfoot>
                            <tr>
                                <td colspan="5">合计</td>
                                <td colspan="4">数量：<span class="sumnum"></span></td>
                                <td colspan="2">金额：<span class="sumamount"></span></td>
                                <td colspan="1">税额：<span class="sumtaxprice"></span></td>
                                <td colspan="8">含税金额：<span class="sumtaxprices"></span></td>
                                <td colspan="1">分摊金额：<span></span></td>
                            </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
                <div class="layui-tab-item">
                    <div class="layui-form-item">
                        <label class="layui-form-label">账款归属</label>
                        <div class="layui-input-inline">
                            <input type="text" name=""
                                   lay-verify="title"
                                   autocomplete="off"
                                   class="layui-input">
                        </div>
                        <label class="layui-form-label">付款日期</label>
                        <div class="layui-input-inline">
                            <input type="text" class="layui-input"
                                   onclick="layui.laydate({elem: this})">
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label">付款条件</label>
                        <div class="layui-input-inline">
                            <select name="">
                                <option value="货到">货到</option>
                                <option value="月结">月结</option>
                                <option value="次月">次月</option>
                                <option value="其他">其他</option>
                            </select>
                        </div>
                        <div class="layui-input-inline">
                            <input type="text" style="float: left;width:95%;"
                                   class="layui-input">
                            <span style="float:left;width: 5%;padding-left: 4px;box-sizing: border-box;line-height: 38px">天</span>
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label">账款月份</label>
                        <div class="layui-input-inline"
                             style="width:73%;">
                            <input type="text" class="layui-input">
                        </div>
                    </div>
                </div>
                <div class="layui-tab-item">
                    <div class="layui-form-item">
                        <label class="layui-form-label">自定栏一</label>
                        <div class="layui-input-inline">
                            <input type="text" id="udef1" class="layui-input" readonly="readonly" name="add_overRead">
                        </div>
                        <label class="layui-form-label">自定栏二</label>
                        <div class="layui-input-inline">
                            <input type="text" id="udef2" class="layui-input" readonly="readonly" name="add_overRead">
                        </div>
                    </div>
                    <div class="layui-form-item layui-form-text">
                        <label class="layui-form-label">备注</label>
                        <div class="layui-input-block">
                            <textarea placeholder="请输入内容" id="remark" class="layui-textarea" readonly="readonly" name="add_overRead"></textarea>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">采购人员</label>
            <div class="layui-input-inline">
                <input type="text" name="person" lay-verify="" autocomplete="off"
                       class="layui-input" readonly="readonly"/>
            </div>
            <label class="layui-form-label">制单人员</label>
            <div class="layui-input-inline">
                <input type="text" name="maker" lay-verify="maker" autocomplete="off"
                       class="layui-input" readonly="readonly" value="Admin"/>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">所属部门</label>
            <div class="layui-input-inline">
                <input type="text" name="deptName" lay-verify="dept" autocomplete="off"
                       class="layui-input" readonly="readonly"/>
            </div>
            <label class="layui-form-label">复核人员</label>
            <div class="layui-input-inline">
                <input type="text" name="permitter" lay-verify="title" autocomplete="off"
                       class="layui-input" readonly="readonly"/>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">所属项目</label>
            <div class="layui-input-inline">
                <input type="text" name="project" lay-verify="project" autocomplete="off"
                       class="layui-input" readonly="readonly"/>
            </div>
        </div>
    </form>
</div>
<div id="wrapper" style="display: none;">
    <table class="layui-table"  id="content" name="content" style="overflow-y: scroll;">
        <thead>
            <tr>
                <th>编号</th>
                <th>名称</th>
            </tr>
        </thead>
        <tbody>

        </tbody>
    </table>
</div>
</body>
<script type="text/javascript" src="../../js/jquery-1.12.4.js"></script>
<script type="text/javascript" src="../../layui/lay/dest/layui.all.js"></script>
<script>
    var dbl=false;
    var dblparam=null;
    var layer = layui.layer
    var form=layui.form();
    getLocalDate();
    if (jQuery("[name=billdate]").val() != "") {
        getBillNo();
    }
    if(jQuery("[name=person]").val()!=""){
        querySubordinateDept();
    }

    function getLocalDate() {
        var date = new Date();
        var year = date.getFullYear();
        var month = (date.getMonth()+1);
        if (month < 10)
            month = "0" + month;
        var day = date.getDate();
        if (day < 10)
            day = "0" + day;
        date = year + "-" + month + "-" + day;
        jQuery("[name=billdate]").val(date);
    }

    var p=1;
    var pageinfo={};
    showPurchase(p);
    function showPurchase(pageNum) {
        var lannum=0;
        dbl=false;
        jQuery.getJSON("/ch/queryPurchase",{"pageNum":pageNum},function (data) {
            console.info(data);
            pageinfo=data;
            jQuery.each(data.list,function (i,obj) {
                jQuery("#billno").val(obj.billno);
                jQuery("[name=billdate]").val(obj.billdate);
                jQuery("[name=cust]").attr("id",obj.custid);
                jQuery("[name=cust]").val(obj.custname);
                jQuery("#custaddress").val(obj.custaddress);
                jQuery("[name=billtype]").attr("id",obj.saleclassid);
                jQuery("[name=billtype]").val(obj.saleclassname);
                jQuery("[name=curr]").attr("id",obj.currid);
                jQuery("[name=curr]").val(obj.currname);
                jQuery("[name=shui] option").each(function (j,o) {
                    if(jQuery(o).text()==obj.priceoftax){
                        jQuery(this).attr("selected","selected");
                    }
                })
                jQuery("[name=exchrate]").val(obj.exchrate.toFixed(4));
                jQuery("[name=ware]").attr("id",obj.wareid);
                jQuery("[name=ware]").val(obj.warename);
                jQuery("[name=person]").attr("id",obj.salesid);
                jQuery("[name=person]").val(obj.salesname);
                jQuery("[name=maker]").attr("id",obj.maker);
                jQuery("[name=maker]").val(obj.makername);
                jQuery("[name=deptName]").val(obj.departname);
                jQuery("[name=project]").val(obj.project);
                jQuery("[name=permitter]").val(obj.permittername);
                jQuery("#udef1").val(obj.udef1);
                jQuery("#udef2").val(obj.udef2);
                jQuery("#remark").val(obj.remark);
                jQuery("#detailinfo tbody").empty();
                jQuery.each(obj.detaillist,function (k,d) {
                    lannum++;
                    var $tr = jQuery("<tr class='cgrkdateil'></tr>");
                    $tr.append("<td>" + lannum + "</td>");
                    $tr.append("<td class='prodid'>"+d.prodid+"</td>");
                    $tr.append("<td class='prodname'>"+d.prodname+"</td>");
                    $tr.append("<td>"+d.prodsize+"</td>");
                    $tr.append("<td>"+d.sunit+"</td>");
                    $tr.append("<td class='num'>"+d.squantity+"</td>");
                    $tr.append("<td class='disprice'>"+parseFloat(d.oldprice).toFixed(2)+"</td>");
                    $tr.append("<td class='discount'>"+parseFloat(d.discount).toFixed(2)+"</td>");
                    $tr.append("<td class='price'>"+parseFloat(d.sprice).toFixed(2)+"</td>");
                    $tr.append("<td class='amout'>"+parseFloat(d.amount).toFixed(2)+"</td>");
                    $tr.append("<td class='taxrate'>"+parseFloat(d.taxrate).toFixed(2)+"</td>");
                    $tr.append("<td class='taxamout'>"+parseFloat(d.taxamt).toFixed(2)+"</td>");
                    $tr.append("<td>"+parseFloat(d.amountatax).toFixed(2)+"</td>");
                    if(d.isgift==0){
                        $tr.append("<td><input type=\"checkbox\" lay-skin=\"primary\" name=\"iszp\" checked='checked'/></td>");
                    }else {
                        $tr.append("<td><input type=\"checkbox\" lay-skin=\"primary\" name=\"iszp\"/></td>");
                    }
                    $tr.append("<td><input type=\"checkbox\" lay-skin=\"primary\"/> </td>");
                    $tr.append("<td><input type=\"checkbox\" lay-skin=\"primary\"/></td>");
                    $tr.append("<td>0</td>");
                    $tr.append("<td>"+d.itemremark+"</td>");
                    $tr.append("<td>"+d.trantype+"</td>");
                    $tr.append("<td>"+d.formno+"</td>");
                    $tr.append("<td>"+parseFloat(d.mlamount).toFixed(2)+"</td>");
                    jQuery("#detailinfo tbody").append($tr);
                    sum();
                    form.render("checkbox");
                })
            })
        })
    }

    $("#menu-prev").click(function () {
        showPurchase(pageinfo.prePage==0?1:pageinfo.prePage);
    });
    $("#menu-next").click(function () {
        showPurchase(pageinfo.pageNum==pageinfo.lastPage?pageinfo.lastPage:pageinfo.nextPage);
    })

    function deletePurchase() {
        jQuery.post("/ch/deletePurchase",{"billno":jQuery("#billno").val()},function (data) {
            console.info(data);
            if(data.code=="200"){
                layer.msg("删除成功");
                showPurchase(p);
            }
        },"json")
    }

     jQuery("#menu-delete").click(function () {
         layer.confirm('是否删除该单据？', {
             btn: ['确定', '取消'],
             yes: function (index) {
                 deletePurchase();
                 layer.close(index);
             }
         })
     })

    function getBillNo() {
        jQuery.getJSON("/ch/getBillNo", {"date": jQuery("[name=billdate]").val()}, function (data) {
            console.info(data);
            jQuery("#billno").val(data);
        })
    }

    function queryWare() {
        jQuery.getJSON("/ch/queryWare", {}, function (data) {
            console.info(data);
            jQuery("#content tbody").empty();
            jQuery.each(data,function (i,obj) {
                var $tr=jQuery("<tr class='chooseInfo'></tr>");
                $tr.append("<td>"+obj.wareid+"</td>");
                $tr.append("<td>"+obj.warename+"</td>");
                jQuery("#content tbody").append($tr);
            })
        })
    }

    function queryBillType() {
        jQuery.getJSON("/ch/queryBillTypeByRk", {}, function (data) {
            console.info(data);
            jQuery("#content tbody").empty();
            jQuery.each(data,function (i,obj) {
                var $tr=jQuery("<tr class='chooseInfo'></tr>");
                $tr.append("<td>"+obj.classid+"</td>");
                $tr.append("<td>"+obj.classname+"</td>");
                jQuery("#content tbody").append($tr);
            })
        })
    }

    function queryPerson() {
        jQuery.getJSON("/ch/queryPerson", {}, function (data) {
            console.info(data);
            jQuery("#content tbody").empty();
            jQuery.each(data,function (i,obj) {
                var $tr=jQuery("<tr class='chooseInfo'></tr>");
                $tr.append("<td>"+obj.personid+"</td>");
                $tr.append("<td>"+obj.personname+"</td>");
                jQuery("#content tbody").append($tr);
            })
        })
    }

    function queryShort() {
        jQuery.getJSON("/ch/queryShort", {}, function (data) {
            console.info(data);
            jQuery("#content tbody").empty();
            jQuery.each(data,function (i,obj) {
                var $tr=jQuery("<tr class='chooseInfo'></tr>");
                $tr.append("<td>"+obj.id+"</td>");
                $tr.append("<td>"+obj.shortname+"</td>");
                jQuery("#content tbody").append($tr);
            })
        })
    }

    function queryProdct() {
        jQuery.getJSON("/ch/queryProdct", {}, function (data) {
            console.info(data);
            jQuery("#content tbody").empty();
            jQuery.each(data,function (i,obj) {
                var $tr=jQuery("<tr class='chooseInfo'></tr>");
                $tr.append("<td>"+obj.prodid+"</td>");
                $tr.append("<td>"+obj.prodname+"</td>");
                jQuery("#content tbody").append($tr);
            })
        })
    }

    var winWrapper;
    function showWrapper(param) {
        dblparam=param;
        winWrapper= layer.open({
            type: 1,
            title: "请选择信息",
            content: $('#wrapper'),
            area: ['500px', '300px'],
            success:function(){
                if(param=="ware"){
                    queryWare();
                }else if(param=="billtype"){
                    queryBillType();
                }else if(param=="person"){
                    queryPerson();
                }else if(param=="cust"){
                    queryShort();
                }else if(param=="prod"){
                    queryProdct();
                }
            },
            cancel: function(index){
                layer.close(index);
            },
            end:function () {
                jQuery("#wrapper").hide();
            }
        });
    }

    jQuery("[name=cust]").dblclick(function () {
        if(dbl==true){
            showWrapper("cust");
        }
    })
    jQuery("[name=billtype]").dblclick(function () {
        if(dbl==true) {
            showWrapper("billtype");
        }
    })
    jQuery("[name=ware]").dblclick(function () {
        if(dbl==true) {
            showWrapper("ware");
        }
    })
    jQuery("[name=person]").dblclick(function () {
        if(dbl==true) {
            showWrapper("person");
        }
    })

    var addorupdate=null;
    jQuery("#menu-add").click(function () {
        dbl = true;
        addorupdate="add";
        jQuery("input[type=text]").val("");
        jQuery("#detailinfo tbody").empty();
        getLocalDate();
        sum();
        getBillNo();
        jQuery("[name=maker]").val("Admin");
        jQuery("[name=curr]").val("人民币");
        jQuery("[name=exchrate]").val("0.0000");
        jQuery("[name=add_overRead]").removeAttr("readonly");
        jQuery("[name=shui]").removeAttr("disabled");
        form.render('select');
    })

    jQuery("#menu-update").click(function () {
        dbl = true;
        addorupdate="update";
        jQuery("[name=add_overRead]").removeAttr("readonly");
        jQuery("[name=shui]").removeAttr("disabled");
        form.render('select');
    })

    jQuery(document.body).on("dblclick",".chooseInfo",function () {
        var id=jQuery(this).find("td").eq(0).text();
        var name=jQuery(this).find("td").eq(1).text();
        if(dblparam=="ware"){
            jQuery("[name=ware]").val(name).attr("id",id);
        }else if(dblparam=="billtype"){
            jQuery("[name=billtype]").val(name).attr("id",id);
        }else if(dblparam=="person"){
            jQuery("[name=person]").val(name).attr("id",id);
            jQuery("[name=person]").change();
        }else if(dblparam=="cust"){
            jQuery("[name=cust]").val(name).attr("id",id);
        }else if(dblparam=="prod"){
            jQuery(proddom).text(id);
            queryProdctInfo(id,proddom);
        }
        layer.close(winWrapper)
    })
    
    function querySubordinateDept() {
        jQuery.getJSON("/ch/querySubordinateDept", {"personname": jQuery("[name=person]").val()}, function (data) {
            console.info(data);
            jQuery("[name=deptName]").val(data);
        })
    }

    jQuery("[name=person]").change(function () {
        querySubordinateDept();
    })

    var lineid=0;
    jQuery("#addLine").click(function () {
        if(dbl==true) {
            if(jQuery("[name=cust]").val()!=""&&jQuery("[name=ware]").val()!=""){
                lineid++;
                var $tr = jQuery("<tr class='cgrkdateil'></tr>");
                $tr.append("<td contenteditable='true'>" + lineid + "</td>");
                $tr.append("<td class='prodid'></td>");
                $tr.append("<td class='prodname' contenteditable='true'></td>");
                $tr.append("<td contenteditable='true'></td>");
                $tr.append("<td contenteditable='true'></td>");
                $tr.append("<td class='num' contenteditable='true'>0</td>");
                $tr.append("<td class='disprice' contenteditable='true'>0.00</td>");
                $tr.append("<td class='discount' contenteditable='true'>100.00</td>");
                $tr.append("<td class='price' contenteditable='true'>0.00</td>");
                $tr.append("<td class='amout' contenteditable='true'>0.00</td>");
                $tr.append("<td class='taxrate' contenteditable='true'>17.00</td>");
                $tr.append("<td class='taxamout'contenteditable='true'>0.00</td>");
                $tr.append("<td contenteditable='true'>0.00</td>");
                $tr.append("<td><input type=\"checkbox\" lay-skin=\"primary\" name=\"iszp\"/></td>");
                $tr.append("<td><input type=\"checkbox\" lay-skin=\"primary\"/> </td>");
                $tr.append("<td><input type=\"checkbox\" lay-skin=\"primary\"/></td>");
                $tr.append("<td contenteditable='true'>0</td>");
                $tr.append("<td contenteditable='true'></td>");
                $tr.append("<td contenteditable='true'></td>");
                $tr.append("<td contenteditable='true'></td>");
                $tr.append("<td contenteditable='true'>0.00</td>");
                jQuery("#detailinfo tbody").append($tr);
                form.render("checkbox");
            }
        }
    })

    var proddom=null;
    jQuery(document.body).on("dblclick",".prodid",function () {
        proddom=jQuery(this);
        showWrapper("prod");
    })
    
    function queryProdctInfo(prodid,dom) {
        var zk=jQuery(dom).parent().find("td").eq(7).text();
        jQuery.getJSON("/ch/queryProdctInfo", {"prodid": prodid}, function (data) {
            console.info(data);
            var dj=data.suggestprice*parseFloat(zk)/100;
            jQuery(dom).parent().find("td").eq(2).text(data.prodname);
            jQuery(dom).parent().find("td").eq(3).text(data.prodsize);
            jQuery(dom).parent().find("td").eq(4).text(data.unit);
            jQuery(dom).parent().find("td").eq(6).text(data.suggestprice.toFixed(2));
            jQuery(dom).parent().find("td").eq(8).text(dj.toFixed(2));
        })
    }

    jQuery(document.body).on("blur",".discount",function () {
        Calculation(jQuery(this).parent(),"discount");
    })

    jQuery(document.body).on("blur",".disprice",function () {
        Calculation(jQuery(this).parent(),"disprice");
    })

    jQuery(document.body).on("blur",".num",function () {
        Calculation(jQuery(this).parent(),"num");
    })

    jQuery(document.body).on("blur",".price",function () {
        Calculation(jQuery(this).parent(),"price");
    })
    jQuery(document.body).on("blur",".amout",function () {
        Calculation(jQuery(this).parent(),"amout");
    })

    jQuery(document.body).on("blur",".taxamut",function () {
        Calculation(jQuery(this).parent(),"taxamut");
    })

    jQuery(document.body).on("blur",".taxrate",function () {
        Calculation(jQuery(this).parent(),"taxrate");
    })
    
    function Calculation(dom,val) {
        var num=parseFloat(jQuery(dom).find("td").eq(5).text());
        var disbeforeprice=parseFloat(jQuery(dom).find("td").eq(6).text());
        var discount=parseFloat(jQuery(dom).find("td").eq(7).text());
        var price=parseFloat(jQuery(dom).find("td").eq(8).text());
        var aount=parseFloat(jQuery(dom).find("td").eq(9).text());
        var taxrate=parseFloat(jQuery(dom).find("td").eq(10).text())/100;
        var taxamount=parseFloat(jQuery(dom).find("td").eq(11).text());
        if(val=="num"){
            num=parseFloat(jQuery(dom).find("td").eq(5).text());
            price=parseFloat(jQuery(dom).find("td").eq(8).text());
            jQuery(dom).find("td").eq(9).text((price*num).toFixed(2));
            aount=parseFloat(jQuery(dom).find("td").eq(9).text());
            jQuery(dom).find("td").eq(11).text((aount*taxrate).toFixed(2));
            taxamount=parseFloat(jQuery(dom).find("td").eq(11).text());
            jQuery(dom).find("td").eq(12).text((aount+taxamount).toFixed(2));
        }else if(val=="discount"){
            discount=parseFloat(jQuery(dom).find("td").eq(7).text());
            aount=parseFloat(jQuery(dom).find("td").eq(9).text());
            taxamount=parseFloat(jQuery(dom).find("td").eq(11).text());
            jQuery(dom).find("td").eq(8).text((aount/num).toFixed(2));
            price=parseFloat(jQuery(dom).find("td").eq(8).text());
            jQuery(dom).find("td").eq(10).text((taxamount / aount * 100).toFixed(2));
            jQuery(dom).find("td").eq(12).text((aount+taxamount).toFixed(2));
        }else if(val=="price"){
            price=parseFloat(jQuery(dom).find("td").eq(8).text());
            aount=parseFloat(jQuery(dom).find("td").eq(9).text());
            taxamount=parseFloat(jQuery(dom).find("td").eq(11).text());
            jQuery(dom).find("td").eq(7).text((price/disbeforeprice*100).toFixed(2))
            jQuery(dom).find("td").eq(10).text((taxamount / aount * 100).toFixed(2));
            jQuery(dom).find("td").eq(12).text((aount+taxamount).toFixed(2));
        }else if(val=="amout"){
            aount=parseFloat(jQuery(dom).find("td").eq(9).text());
            jQuery(dom).find("td").eq(8).text((aount/num).toFixed(2));
            price=parseFloat(jQuery(dom).find("td").eq(8).text());
            jQuery(dom).find("td").eq(7).text((price/disbeforeprice*100).toFixed(2))
            jQuery(dom).find("td").eq(11).text(aount*taxrate.toFixed(2));
            taxamount=parseFloat(jQuery(dom).find("td").eq(11).text());
            jQuery(dom).find("td").eq(12).text((aount+taxamount).toFixed(2));
        }else if(val=="taxrate"){
            aount=parseFloat(jQuery(dom).find("td").eq(9).text());
            taxamount=parseFloat(jQuery(dom).find("td").eq(11).text());
            jQuery(dom).find("td").eq(11).text(aount*taxrate.toFixed(2));
            jQuery(dom).find("td").eq(12).text((aount+taxamount).toFixed(2));
        }else if(val=="taxamout"){
            aount=parseFloat(jQuery(dom).find("td").eq(9).text());
            taxamount=parseFloat(jQuery(dom).find("td").eq(11).text());
            jQuery(dom).find("td").eq(10).text((taxamount / aount * 100).toFixed(2));
            jQuery(dom).find("td").eq(12).text((aount+taxamount).toFixed(2));
        }
        sum();
    }


    function sum(){
        var sumnum=0;
        var sumamount=0;
        var sumtaxprice=0;
        var sumtaxprices=0;
        jQuery("#detailinfo tbody tr").each(function (i,obj) {
            sumnum+=parseInt(jQuery(obj).find("td").eq(5).text());
            sumamount+=parseInt(jQuery(obj).find("td").eq(9).text());
            sumtaxprice+=parseInt(jQuery(obj).find("td").eq(11).text());
            sumtaxprices+=parseInt(jQuery(obj).find("td").eq(12).text());
        })
        jQuery(".sumnum").text(sumnum);
        jQuery(".sumamount").text(sumamount.toFixed(2));
        jQuery(".sumtaxprice").text(sumtaxprice.toFixed(2));
        jQuery(".sumtaxprices").text(sumtaxprices.toFixed(2));
    }

    jQuery("#menu-save").click(function () {
        if(dbl==true){
            save();
        }
    })

    function save() {
        saveok=false;
        if (jQuery("#detailinfo tbody tr").size()==0){
            layer.msg("表身不允许空白！");
            return false;
        }else{
            jQuery("#detailinfo tbody tr").each(function (i,obj) {
                if(parseInt(jQuery(obj).find("td").eq(5).text())==0){
                    layer.msg("数量不能为0！");
                    return false;
                }
            })
        }
        var purchase={};
        purchase["billno"]=jQuery("#billno").val();
        purchase["billdate"]=jQuery("[name=billdate]").val();
        purchase["custid"]=jQuery("[name=cust]").attr("id");
        purchase["custname"]=jQuery("[name=cust]").val();
        purchase["custaddress"]=jQuery("#custaddress").val();
        purchase["saleclassid"]=jQuery("[name=billtype]").attr("id");
        purchase["saleclassname"]=jQuery("[name=billtype]").val();
        purchase["currid"]="01";
        purchase["currname"]=jQuery("[name=curr]").val();
        purchase["priceoftax"]=jQuery("[name=shui] option:selected").val();
        purchase["exchrate"]=jQuery("[name=exchrate]").val();
        purchase["wareid"]=jQuery("[name=ware]").attr("id");
        purchase["warename"]=jQuery("[name=ware]").val();
        purchase["salesid"]=jQuery("[name=person]").attr("id");
        purchase["salesname"]=jQuery("[name=person]").val();
        purchase["maker"]=jQuery("[name=maker]").attr("id");
        purchase["makername"]=jQuery("[name=maker]").val();
        purchase["permittername"]="Admin";
        purchase["departname"]=jQuery("[name=deptName]").val();
        purchase["projectname"]=jQuery("[name=project]").val();
        purchase["udef1"]=jQuery("#udef1").val();
        purchase["udef2"]=jQuery("#udef2").val();
        purchase["remark"]=jQuery("#remark").val();
        var dateils=new Array();
        jQuery("#detailinfo tbody tr").each(function (i,obj) {
            var dateil={};
            dateil["billno"]=jQuery("#billno").val();
            dateil["prodid"]=jQuery(obj).find("td").eq(1).text()
            dateil["prodname"]=jQuery(obj).find("td").eq(2).text()
            dateil["prodsize"]=jQuery(obj).find("td").eq(3).text()
            dateil["sunit"]=jQuery(obj).find("td").eq(4).text()
            dateil["squantity"]=jQuery(obj).find("td").eq(5).text()
            dateil["oldprice"]=jQuery(obj).find("td").eq(6).text()
            dateil["discount"]=jQuery(obj).find("td").eq(7).text()
            dateil["sprice"]=jQuery(obj).find("td").eq(8).text()
            dateil["amount"]=jQuery(obj).find("td").eq(9).text()
            dateil["taxrate"]=jQuery(obj).find("td").eq(10).text()
            dateil["taxamt"]=jQuery(obj).find("td").eq(11).text()
            dateil["amountatax"]=jQuery(obj).find("td").eq(12).text()
            if(jQuery(obj).find("td").eq(14).is(":checked")){
                dateil["isgift"]=0;
            }else{
                dateil["isgift"]=1;
            }
            dateil["itemremark"]=jQuery(obj).find("td").eq(17).text()
            dateil["trantype"]=jQuery(obj).find("td").eq(18).text()
            dateil["formno"]=jQuery(obj).find("td").eq(19).text()
            dateil["mlamount"]=jQuery(obj).find("td").eq(20).text()
            dateils.push(dateil);
        })
        purchase["detaillist"]=dateils;
        if(addorupdate=="add") {
            $.ajax({
                url: "/ch/savePurchase",
                type: "post",
                contentType: "application/json",
                data: JSON.stringify(purchase),
                dataType: "json",
                timeout: 5000,
                success: function (data) {
                    console.info(data)
                    if (data.code == "200") {
                        layer.msg("保存成功");
                        saveok = true;
                        showPurchase(p);
                    } else {
                        layer.msg("保存失败");
                    }
                }
            })
        }else if(addorupdate=="update"){
            $.ajax({
                url: "/ch/updatePurchase",
                type: "post",
                contentType: "application/json",
                data: JSON.stringify(purchase),
                dataType: "json",
                timeout: 5000,
                success: function (data) {
                    console.info(data)
                    if (data.code == "200") {
                        layer.msg("修改成功");
                        saveok = true;
                        showPurchase(p);
                    } else {
                        layer.msg("修改失败");
                    }
                }
            })
        }
    }

    var saveok=true;
    jQuery("#menu-adopt").click(function () {
        if (saveok==true) {
            jQuery("form").addClass("pic-ok");
        }
    })

    var saveok=true;
    jQuery("#menu-adopt").click(function () {
        if (saveok==true) {
            jQuery("form").addClass("pic-ok");
        }
    })

    jQuery("#menu-refuse").click(function () {
        if (saveok==true) {
            jQuery("form").removeClass("pic-ok");
        }
    })

    jQuery("#menu-refuse").click(function () {
        if (saveok==true) {
            jQuery("form").removeClass("pic-ok");
        }
    })
</script>
</html>