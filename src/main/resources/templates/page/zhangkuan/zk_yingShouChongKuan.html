<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title>应收冲款单</title>
	<link rel="icon" href="../../favicon.ico">
	<link rel="stylesheet" href="../../layui/css/layui.css" media="all"/>
	<link rel="stylesheet" href="../../css/zhangkuan/zk_yingShouChongKuan.css">
	<style>
	</style>
	<link rel="stylesheet" href="../../css/common.css">
</head>
<body style="width: 100%;padding: 10px 20px;box-sizing: border-box;min-width: 900px;">
<form class="layui-form" action="" id="vmindexCnt">
	<div class="layui-form-item">
		<div class="layui-input-block" style="margin-left: 0">
			<ul class="layui-nav" style="background-color: transparent;">
				<li class="layui-nav-item">
					<a href="javascript:;" class="iconfont menu-list" title="上一条" id="menu-prev">
						<i class="layui-icon">&#xe603;</i>
					</a>
				</li>
				<li class="layui-nav-item">
					<a href="javascript:;" class="iconfont menu-list" title="下一条" id="menu-next">
						<i class="layui-icon">&#xe602;</i>
					</a>
				</li>
				<li class="layui-nav-item">
					<a href="javascript:;" class="iconfont menu-list" title="新增" id="menu-add">
						<i class="layui-icon">&#xe654;</i>
					</a>
				</li>
				<li class="layui-nav-item">
					<a href="javascript:;" class="iconfont menu-list" title="修改" id="menu-update" disabled>
						<i class="layui-icon">&#xe642;</i>
					</a>
				</li>
				<li class="layui-nav-item">
					<a href="javascript:;" class="iconfont menu-list" title="删除" id="menu-delete">
						<i class="layui-icon">&#xe640;</i>
					</a>
				</li>
				<li class="layui-nav-item">
					<a href="javascript:void(0);" class="iconfont menu-list" title="保存" id="menu-save">
						<i class="layui-icon">&#xe61d;</i>
					</a>
				</li>
				<li class="layui-nav-item">
					<a href="javascript:;" class="iconfont menu-list" title="审核" id="menu-adopt" disabled="">
						<i class="layui-icon">&#xe605;</i>
					</a>
				</li>
				<li class="layui-nav-item">
					<a href="javascript:;" class="iconfont menu-list" title="反审核" id="menu-refuse">
						<i class="layui-icon">&#x1006;</i>
					</a>
				</li>
				<li class="layui-nav-item">
					<a href="javascript:;" class="iconfont menu-list" title="刷新" id="menu-refresh">
						<i class="layui-icon">&#x1002;</i>
					</a>
				</li>
				<li class="layui-nav-item">
					<a href="javascript:;" class="iconfont menu-list" title="刷新" id="menu-refresh">
						<i class="layui-icon">&#x1002;</i>
					</a>
				</li>
				<li class="layui-nav-item" style="margin-left: 20px;">
					<a href="javascript:;">功能</a>
					<dl class="layui-nav-child">
						<dd><a href="">载入单币别账款</a></dd>
						<dd><a href="">载入多币别账款</a></dd>
						<dd><a href="">载入预收</a></dd>
					</dl>
				</li>
				<li class="layui-nav-item" style="margin-left: 20px;">
					<a href="javascript:;">自动计算</a>
					<dl class="layui-nav-child">
						<dd><a href="">以下冲款</a></dd>
						<dd><a href="">以下折让</a></dd>
						<dd><a href="">以下空白</a></dd>
					</dl>
				</li>
			</ul>
		</div>
	</div>
	<div class="layui-form-item">
		<label class="layui-form-label">客户</label>
		<div class="layui-input-inline">
			<input type="text"  name="customername" required lay-verify="required" autocomplete="off"
				   class="layui-input">
		</div>
		<label class="layui-form-label">单据时间</label>
		<div class="layui-input-inline">
			<input type="date" name="fundbilldate" onclick="layui.laydate({elem: this,choose:getBillNo})"  readonly="readonly"   required lay-verify="required" autocomplete="off"
				   class="layui-input">
		</div>
	</div>
	<div class="layui-form-item">
		<label class="layui-form-label">结算方式一</label>
		<div class="layui-input-inline">
			<input type="text" name="cashstylename" required lay-verify="required" autocomplete="off"
				   class="layui-input">
			&nbsp;&nbsp;
			<input type="text" name="cash" required lay-verify="required" autocomplete="off"
				   class="layui-input">
		</div>
		<label class="layui-form-label">单据号码</label>
		<div class="layui-input-inline">
			<input type="text"  name="fundbillid" required lay-verify="required" autocomplete="off"
				   class="layui-input">
		</div>
	</div>
	<div class="layui-form-item">
		<label class="layui-form-label">结算方式二</label>
		<div class="layui-input-inline">
			<input type="text" name="visastylename"  required lay-verify="required" autocomplete="off"
				   class="layui-input">
			&nbsp;&nbsp;
			<input type="text" name="visa"  required lay-verify="required" autocomplete="off"
				   class="layui-input">
		</div>
		<label class="layui-form-label">币别</label>
		<div class="layui-input-inline">
			<input type="text" name="bcurrencyname" required lay-verify="required" autocomplete="off"
				   class="layui-input">
		</div>
	</div>
	<div class="layui-form-item">
		<label class="layui-form-label">结算方式三</label>
		<div class="layui-input-inline">
			<input type="text" name="otherpaystylename" required lay-verify="required" autocomplete="off"
				   class="layui-input">
			&nbsp;&nbsp;
			<input type="text" name="otherpay" required lay-verify="required" autocomplete="off"
				   class="layui-input">
		</div>
		<label class="layui-form-label">汇率</label>
		<div class="layui-input-inline">
			<input type="text" name="exchangerate" required lay-verify="required" autocomplete="off"
				   class="layui-input">
		</div>
	</div>
	<div class="layui-form-item">
		<label class="layui-form-label">折扣率(%)</label>
		<div class="layui-input-inline">
			<input type="text" name="discountper" required lay-verify="required" autocomplete="off"
				   class="layui-input">
		</div>

	</div>
	<div class="layui-form-item">
		<label class="layui-form-label">终止账月</label>
		<div class="layui-input-inline">
			<input type="date" name="accmonthtomonth" required lay-verify="required" autocomplete="off"
				   class="layui-input">
		</div>
		<label class="layui-form-label">凭证编号</label>
		<div class="layui-input-inline">
			<input type="text" name="voucherno" required lay-verify="required" autocomplete="off"
				   class="layui-input">
		</div>
	</div>

	<div class="layui-tab layui-tab-card" id="tab3">
		<ul class="layui-tab-title">
			<li class="layui-this">内容</li>
			<li>取用预收</li>
			<li>备注</li>
		</ul>
		<div class="layui-tab-content" style="height: 200px;overflow: scroll">
			<div class="layui-tab-item layui-show">
				<table class="layui-table" style="width: 3000px" id="detailinfo">
					<thead>
					<tr>
						<th>栏号</th>
						<th>单别</th>
						<th>原单单号</th>
						<th>币别</th>
						<th>原单金额</th>
						<th>现行金额</th>
						<th>折让金额</th>
						<th>冲款金额</th>
						<th>冲抵金额</th>
					</tr>
					</thead>
					<tbody  id="list">

					</tbody>
				</table>
			</div>
			<div class="layui-tab-item">
				<table class="layui-table">
					<thead>
					<tr>
						<th>应收冲款单号</th>
						<th>来源别</th>
						<th>来源单号</th>
						<th>预收金额</th>
						<th>部门编号</th>
						<th>部门名称</th>
						<th>取用预收金额</th>
						<th>来源摘要</th>
					</tr>
					</thead>
					<tbody>
					</tbody>
				</table>
			</div>
			<div class="layui-tab-item">
				<div class="layui-form-item">
					<label class="layui-form-label">自定栏一</label>
					<div class="layui-input-inline">
						<select  name="customcolumnone"  class="layui-select" lay-verify="required">

                            <option value="">请选择</option>
                            <option value="预收款">预收款</option>
                            <option value="原单金额">原单金额</option>
                            <option value="现行金额">现行金额</option>
						</select>
					</div>
					<label class="layui-form-label">自定栏二</label>
					<div class="layui-input-inline">
						<select  name="customcolumntwo" class="layui-select" lay-verify="required">
							<option value="">请选择</option>
                            <option value="预收款">预收款</option>
                            <option value="原单金额">原单金额</option>
                            <option value="现行金额">现行金额</option>
						</select>
					</div>
				</div>
				<div class="layui-form-item">
					<label class="layui-form-label">备注</label>
					<div class="layui-input-block">
							<textarea name="remarks"  placeholder="请输入内容"
									  class="layui-textarea"></textarea>
					</div>
				</div>
			</div>
		</div>
	</div>

	<div class="layui-form-item">
		<label class="layui-form-label">所属部门</label>
		<div class="layui-input-inline">
			<input type="text" name="departnamefrom" required lay-verify="required" autocomplete="off"
				   class="layui-input"  readonly="readonly">
		</div>
		<label class="layui-form-label">制单人员</label>
		<div class="layui-input-inline">
			<input type="text" name="makersign" required lay-verify="required" autocomplete="off"
				   class="layui-input">
		</div>
	</div>
	<div class="layui-form-item">
		<label class="layui-form-label">所属项目</label>
		<div class="layui-input-inline">
			<input type="text" name="projectfrom" required lay-verify="required" autocomplete="off"
				   class="layui-input">
		</div>
		<label class="layui-form-label">复核人员</label>
		<div class="layui-input-inline">
			<input type="text" name="fermittersign" required lay-verify="required" autocomplete="off"
				   class="layui-input">
		</div>
	</div>
</form>
<div id="wrapper" style="display: none;">
    <table class="layui-table"  id="content" style="overflow-y: scroll;">
        <thead>
        <tr>
            <th>编号</th>
            <th>名称</th>
        </tr>
        </thead>
        <tbody>

        </tbody>
    </table>
</div>

</body>
<script src="../../layui/lay/dest/layui.all.js"></script>
<script src="../../js/jquery-1.12.4.js"></script>
<script>
    var dbl=false;
    var dblparam=null;
    var layer = layui.layer;
    var form=layui.form();

    //ajax全局设置
    $.ajaxSetup({
        timeout: 6000
    });
    $(document).ajaxError(function() {
        showAlertDialog('服务器异常');
    });
    var num=1;
    var pageinfo={};
    function load(num){

        $.getJSON("/zg/getReceivablecharge",{
            "page":num
        },function (data) {
            console.info(data);
            pageinfo=data;
            $.each(data.list,function (i,obj) {
                $("[name=customername]").val(obj.customername);
                $("[name=fundbilldate]").val(obj.fundbilldate);
                $("[name=cashstylename]").val(obj.cashstylename);
                $("[name=cash]").val(obj.cash);
                $("[name=fundbillid]").val(obj.fundbillid);
                $("[name=visastylename]").val(obj.visastylename);
                $("[name=bcurrencyname]").val(obj.bcurrencyname);
                $("[name=otherpaystylename]").val(obj.otherpaystylename);
                $("[name=otherpay]").val(obj.otherpay);
                $("[name=exchangerate]").val(obj.exchangerate);
                $("[name=discountper]").val(obj.discountper);
                $("[name=accmonthtomonth]").val(obj.accmonthtomonth);
                /*$.each(obj.receivablechargedetails,function (j,objs) {
                    $("#list").html("");
                    var $row=("<tr><td>"+(i+1)+"</td><td> "+objs.sourcelist+"</td><td>"+objs.sourcenumber+"</td><td>"+objs.bcurrencyname+"</td><td>"+objs.originalamount+"</td><td>"+objs.currentamount+"</td><td>"+objs.moneycharged+"</td><td>"+objs.offsetamount+"</td></tr>");
                    $("#list").append($row);

                });*/
            })
        });
    }
    load(num);


    $("#menu-prev").click(function () {
        load(pageinfo.prePage==0?1:pageinfo.prePage);
    });
    $("#menu-next").click(function () {
        load(pageinfo.pageNum==pageinfo.lastPage?pageinfo.lastPage:pageinfo.nextPage);
    })


    getLocalDate();
    if (jQuery("[name=fundbilldate]").val() != "") {
        getBillNo();
    }


    function getLocalDate() {
        var date = new Date();
        var year = date.getFullYear();
        var month = date.getMonth();
        if (month < 10)
            month = "0" + month;
        var day = date.getDate();
        if (day < 10)
            day = "0" + day;
        date = year + "-" + month + "-" + day;
        jQuery("[name=fundbilldate]").val(date);
    }

    function getBillNo() {
        jQuery.getJSON("/zg/getBillNo", {"date": jQuery("[name=fundbilldate]").val()}, function (data) {
            console.info(data);
            jQuery("[name=fundbillid]").val(data);
        })
    }

    function queryDepartment() {
        jQuery.getJSON("/zg/queryDepartment", {}, function (data) {
            console.info(data);
            jQuery("#content tbody").empty();
            jQuery.each(data,function (i,obj) {
                var $tr=jQuery("<tr class='chooseInfo'></tr>");
                $tr.append("<td>"+obj.departid+"</td>");
                $tr.append("<td>"+obj.departname+"</td>");
                jQuery("#content tbody").append($tr);
            })
        })
    }

    function queryCUSTOMER_INFORMATION() {
        jQuery.getJSON("/zg/queryCUSTOMER_INFORMATION", {}, function (data) {
            console.info(data);
            jQuery("#content tbody").empty();
            jQuery.each(data,function (i,obj) {
                var $tr=jQuery("<tr class='chooseInfo'></tr>");
                $tr.append("<td>"+obj.customerid+"</td>");
                $tr.append("<td>"+obj.customerabreviation+"</td>");
                jQuery("#content tbody").append($tr);
            })
        })
    }

    var winWrapper;
    function showWrapper(param) {
        dblparam=param;
        winWrapper= layer.open({
            type: 1,
            title: "请选择信息",
            content: $('#wrapper'),
            area: ['500px', '300px'],
            success:function(){
                if(param=="customername"){
                    queryCUSTOMER_INFORMATION();
                }else if(param=="departnamefrom"){
                    queryDepartment();
                }
            },
            cancel: function(index){
                layer.close(index);
            },
            end:function () {
                jQuery("#wrapper").hide();
            }
        });
    }

    jQuery("[name=customername]").dblclick(function () {
        if(dbl==true){
            showWrapper("customername");
        }
    });

    jQuery("[name=departnamefrom]").dblclick(function () {
        if(dbl==true){
            showWrapper("departnamefrom");
        }
    })

    jQuery("#menu-add").click(function () {
        dbl = true;
        jQuery("[name=add_overRead]").removeAttr("readonly");

        form.render('select');
    });
    jQuery(document.body).on("dblclick",".chooseInfo",function () {
        var id=jQuery(this).find("td").eq(0).text();
        var name=jQuery(this).find("td").eq(1).text();
        if(dblparam=="customername"){
            jQuery("[name=customername]").val(name).attr("id",id);
        }else if(dblparam=="departnamefrom"){
            jQuery("[name=departnamefrom]").val(name).attr("id",id);
        }
        layer.close(winWrapper)
    });


    jQuery("#menu-save").click(function () {
        if(dbl==true){
            save();
        }
    });

    function save() {
        if (jQuery("#detailinfo tbody tr").size()==0){
            layer.msg("表身不允许空白！");
            return false;
        }else{
            jQuery("#detailinfo tbody tr").each(function (i,obj) {
                if(parseInt(jQuery(obj).find("td").eq(3).text())==""){
                    layer.msg("原单单号不能为空！");
                    return false;
                }
            })
        }
        var Receivablecharge={};
        Receivablecharge["fundbillid"]=jQuery("[name=fundbillid]").val();
        Receivablecharge["fundbilldate"]=jQuery("[name=fundbilldate]").val();
        Receivablecharge["customername"]=jQuery("[name=customername]").val();
        Receivablecharge["cashstylename"]=jQuery("[name=cashstylename]").val();
        Receivablecharge["cash"]=jQuery("[name=cash]").attr("id");
        Receivablecharge["visastylename"]=jQuery("[name=visastylename]").val();
        Receivablecharge["visa"]=jQuery("[name=visa]").val();
        Receivablecharge["otherpaystylename"]=jQuery("[name=otherpaystylename]").val();
        Receivablecharge["otherpay"]=jQuery("[name=otherpay]").val();
        Receivablecharge["bcurrencyname"]=jQuery("[name=bcurrencyname]").attr("id");
        Receivablecharge["exchangerate"]=jQuery("[name=exchangerate]").val();
        Receivablecharge["discountper"]=jQuery("[name=discountper]").attr("id");
        Receivablecharge["accmonthtomonth"]=jQuery("[name=accmonthtomonth]").val();
        Receivablecharge["voucherno"]=jQuery("[name=voucherno]").attr("id");
        Receivablecharge["departnamefrom"]=jQuery("[name=departnamefrom]").val();
        Receivablecharge["makersign"]=jQuery("[name=makersign]").val();
        Receivablecharge["projectfrom"]=jQuery("[name=projectfrom]").val();
        Receivablecharge["fermittersign"]=jQuery("#fermittersign").val();
        Receivablecharge["customcolumnone"]=jQuery("#customcolumnone").val();
        Receivablecharge["customcolumntwo"]=jQuery("#customcolumntwo").val();
        Receivablecharge["remarks"]=jQuery("#remarks").val();
        var receivablechargedetails=new Array();
        jQuery("#detailinfo tbody tr").each(function (i,obj) {
            var dateil={};


            var timestamp = (new Date()).getTime();
            dateil["fundbillid"]=timestamp;
            dateil["linenumber"]=jQuery(obj).find("td").eq(0).text();
            dateil["sourcelist"]=jQuery(obj).find("td").eq(1).text();
            dateil["sourcenumber"]=jQuery(obj).find("td").eq(2).text();
            dateil["bcurrencyname"]=jQuery(obj).find("td").eq(3).text();
            dateil["originalamount"]=jQuery(obj).find("td").eq(4).text();
            dateil["currentamount"]=jQuery(obj).find("td").eq(5).text();
            dateil["moneycharged"]=jQuery(obj).find("td").eq(6).text();
            dateil["offsetamount"]=jQuery(obj).find("td").eq(7).text();
            receivablechargedetails.push(dateil);
        });
        Receivablecharge["receivablechargedetails"]=receivablechargedetails;
        $.ajax({
            url:"/zg/addReceivablecharge",
            type:"post",
            contentType:"application/json",
            data:JSON.stringify(Receivablecharge),
            dataType:"json",
            timeout:5000,
            success:function(data){
                console.info(data)
                if(data.code=="200"){
                    layer.msg("保存成功");
                    load(num);
                }else{
                    layer.msg("保存失败");
                }
            }
        })
    }

    function removeAdvancereceipt() {
        var fundbillid=jQuery("[name=fundbillid]").val();
        $.post("/zg/deleteReceivablecharge",{
            "fundbillid":fundbillid
        }, function(data) {
            if (data.code == 200) {
                alert("移除成功");
                load(num);
            } else {
                alert("移除失败");
            }
        },"json");
    }
    jQuery("#menu-delete").click(function () {
        layer.confirm('是否删除该单据？', {
            btn: ['确定', '取消'],
            yes: function (index) {
                removeAdvancereceipt();
                layer.close(index);
            }
        });
    });

    function  update() {
        if (jQuery("#detailinfo tbody tr").size()==0){
            layer.msg("表身不允许空白！");
            return false;
        }else{
            jQuery("#detailinfo tbody tr").each(function (i,obj) {
                if(parseInt(jQuery(obj).find("td").eq(3).text())==""){
                    layer.msg("来源单号不能为空！");
                    return false;
                }
            })
        }
        var Advancereceipt={};
        Advancereceipt["fundbillid"]=jQuery("[name=fundbillid]").val();
        Advancereceipt["fundbilldate"]=jQuery("[name=fundbilldate]").val();
        Advancereceipt["customername"]=jQuery("[name=customername]").val();
        Advancereceipt["cashstylename"]=jQuery("[name=cashstylename]").val();
        Advancereceipt["cash"]=jQuery("[name=cash]").attr("id");
        Advancereceipt["visastylename"]=jQuery("[name=visastylename]").val();
        Advancereceipt["visa"]=jQuery("[name=visa]").val();
        Advancereceipt["otherpaystylename"]=jQuery("[name=otherpaystylename]").val();
        Advancereceipt["otherpay"]=jQuery("[name=otherpay]").val();
        Advancereceipt["bcurrencyname"]=jQuery("[name=bcurrencyname]").attr("id");
        Advancereceipt["exchangerate"]=jQuery("[name=exchangerate]").val();
        Advancereceipt["discountper"]=jQuery("[name=discountper]").attr("id");
        Advancereceipt["accmonthtomonth"]=jQuery("[name=accmonthtomonth]").val();
        Advancereceipt["voucherno"]=jQuery("[name=voucherno]").attr("id");
        Advancereceipt["departnamefrom"]=jQuery("[name=departnamefrom]").val();
        Advancereceipt["makersign"]=jQuery("[name=makersign]").val();
        Advancereceipt["projectfrom"]=jQuery("[name=projectfrom]").val();
        Advancereceipt["fermittersign"]=jQuery("#fermittersign").val();
        Advancereceipt["customcolumnone"]=jQuery("#customcolumnone").val();
        Advancereceipt["customcolumntwo"]=jQuery("#customcolumntwo").val();
        Advancereceipt["remarks"]=jQuery("#remarks").val();
        var receivablechargedetails=new Array();
        jQuery("#detailinfo tbody tr").each(function (i,obj) {
            var dateil={};


            var timestamp = (new Date()).getTime();
            dateil["fundbillid"]=timestamp;

            dateil["linenumber"]=jQuery(obj).find("td").eq(0).text();
            dateil["sourcelist"]=jQuery(obj).find("td").eq(1).text();
            dateil["sourcenumber"]=jQuery(obj).find("td").eq(2).text();
            dateil["bcurrencyname"]=jQuery(obj).find("td").eq(3).text();
            dateil["originalamount"]=jQuery(obj).find("td").eq(4).text();
            dateil["currentamount"]=jQuery(obj).find("td").eq(5).text();
            dateil["moneycharged"]=jQuery(obj).find("td").eq(6).text();
            dateil["offsetamount"]=jQuery(obj).find("td").eq(7).text();
            receivablechargedetails.push(dateil);
        });
        Receivablecharge["receivablechargedetails"]=receivablechargedetails;
        $.ajax({
            url:"/zg/updateReceivablecharge",
            type:"post",
            contentType:"application/json",
            data:JSON.stringify(Advancereceipt),
            dataType:"json",
            timeout:5000,
            success:function(data){
                console.info(data)
                if(data.code=="200"){
                    layer.msg("修改成功");
                    load(num);
                }else{
                    layer.msg("修改失败");
                }
            }
        })
    }

    jQuery("#menu-update").click(function () {
        if(dbl==true){
            update();
        }
    })




</script>
</html>
